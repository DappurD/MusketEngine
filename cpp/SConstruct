#!/usr/bin/env python
"""
SConstruct — The Musket Engine GDExtension build.
Links godot-cpp and Flecs into musket_engine.dll.
"""

import os
import sys

# ── godot-cpp ──────────────────────────────────────────────
env = SConscript("godot-cpp/SConstruct")

# ── Flecs (header-only mode) ──────────────────────────────
env.Append(CPPPATH=["flecs/"])
env.Append(CPPDEFINES=["flecs_STATIC"])

# ── Source files ──────────────────────────────────────────
env.Append(CPPPATH=["src/", "src/ecs/"])

# UNITY BUILD: Compile ONLY the entry point and the master include.
# Do NOT use Glob("src/ecs/*.cpp") — it would double-compile files
# already #included by musket_master.cpp, causing LNK2005 errors.
# See src/ecs/musket_master.cpp header comment for the rationale.
sources = [
    "src/register_types.cpp",   # GDExtension init (must stay separate)
    "src/ecs/musket_master.cpp", # Unity Build (all ECS game logic)
]

# Flecs single-header implementation (pure C, stays separate)
sources += Glob("flecs/*.c")

# ── Output library ────────────────────────────────────────
library = env.SharedLibrary(
    target="../bin/musket_engine{}".format(env["SHLIBSUFFIX"]),
    source=sources,
)

Default(library)
